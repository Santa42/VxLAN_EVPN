
____
<cut/>

Предыдущие части цикла можно найти по ссылкам:

- [1 часть цикла - L2 связанность между серверами](https://habr.com/ru/company/otus/blog/505442/)
- [2 часть цикла - Маршрутизация между VNI](https://habr.com/ru/company/otus/blog/506800/)
- [2.5 часть цикла - Теоретическое отступление](https://habr.com/ru/company/otus/blog/518128/)
- [3 часть цикла - Подключение внешнего маршрутизатора/firewall](https://habr.com/ru/company/otus/blog/519256/)
- [4 часть цикла - Multipod](https://habr.com/ru/company/otus/blog/526628/)

Сегодня рассмотрим второй способ подключение различных ЦОД - Multisite.

Для начала вспомним как строится Underlay при построении фабрики с помощью Multipod. И снова получаем
несколько вариантов построения такой сети. То есть:
1. Underlay сеть может быть единой и, например, использовать OSPF для IP связанности между всеми устройствами в фабрике.
2. Underlay повторяет логику BGP для настройки EVPN и каждый POD находится в своей AS, как показано на рисунке ниже

![](img/Overlay_part5/Underlay_BGP.jpeg)

Однако, вспоминаяю предыдущую часть, приходим к тому, что во всех случаях возникают свои проблемы.
Так в 1 случае, при едином OSPF процессе, может появиться слишком большое количество устройств и динамическая маршрутизация 
станет работать заметно медленнее и больше нагружать сетевые устройства
Во 2-м случае возникает еще больше проблем (ниже указаны не все проблемы, а только основные):
1. Смена Next-Hop. С использованием eBGP, при выходе update из AS, Next-hop меняется. То есть не забываем делать соответствующие настройки
2. Общая проблема для обоих случаев - значение Route-target в автоматическом режиме работать не будет. То есть необходимо использовать статическую настройку, однако это решается автоматизацией таких настроек и сети в целом.
3. П ереполнение таблиц BGP и повышенная нагрузка на сеть (особенно, если не используется ARP-suppression). С увелечением  количества клиентов, увлечивается и количество MAC/IP адрессов и Broadcast трафик соответственно.

Исходя из перечисленных выше недостатков приходим к тому, что необходимо сегментировать сеть и реализуем это через технологию Multisite.

Для начала обсудим какие преумещества дает сегментация сети.

1. Уменьшение домена рассылки Broadcast для поиска какого-либо клиента сети;
2. Упрощается объединение различных подов через сеть интернет;
3. Проблемы в одном поде никак не влияют на другой под
3. Так как теперь каждый под независим от другого, то возможно использовать на одном сайте ingress replication, а на другом Multicast. То есть ЦОД с различными технологиями объединяются без каких-либо проблем миграции.

![](img/Overlay_part5/Multisite_mul_ing.jpg)

Осталось разобраться как работает данная технология. Для начала разберем теоретическую часть.

При реализации Multisite в сети появляется еще одна роль устройства - BGW(Border Gateway), которая может быть присвоена Spine, а может стать отдельным устройством в сети.
В схему дополнительное устройство встраивается выше Spine, как показано на рисунке ниже:

![](img/Overlay_part5/BGW.jpg)

Но на самом деле, поставить BGW возможно в любое место в сети, главное обеспечить IP связанность, но надо ли?

Осталось разобраться как же это все работает